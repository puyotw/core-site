---
layout: post
title: 障礙氣泡量公式
tags: ['規則相關', '得分計算', '同消']
---
{%- comment -%}
related:
B.h.iv.多連結的得分
C.a.ii.全消、全消戰
C.b.i.概論
C.c.iii.高連鎖數vs高同消數
D.a.iii.加倍時間
{%- endcomment -%}

在魔法氣泡的對戰中，玩家發動連鎖會給對手攻擊，也就是障礙氣泡。障礙氣泡的數量其實是由得分與加倍時間決定（得分顯示在場地的下方），而其中得分的算法，依據可消除的氣泡個數也有不同。以下，我們先討論在沒有加倍時間、可消除氣泡數量為4顆（預設可消除數量）的分數計算方法[^1]。

## 分數計算：基本概念

當玩家發動一個總數為 $$n$$ 的連鎖時，送給對手的障礙氣泡總數為

$$
\text{送給對手的障礙氣泡總數} = \left\lfloor 
    \frac{1}{70} \left( 
        \sum_{k=1}^{n}\text{第 } k \text{ 連鎖得分 } S_k + \text{連鎖發動前累積的落下得分}
    \right)
\right\rfloor
$$

其中 $$\lfloor \ \rfloor$$ 是向下取整，整個公式的意思是取括號內數字除以 $$70$$ 的商。這個 $$70$$ 就是「障礙氣泡的換算率」，預設為 $$70$$，在近幾個版本玩家都能在遊戲內調整換算率。

公式中的落下得分，其計算方式為，緩降（soft drop）時氣泡經過一格加一分。發動完 $$n$$ 連鎖後，累積的這些落下得分與每次連鎖得分相加，除完 $$70$$ 的商是障礙氣泡量，餘數則保存起來，待下次發動連鎖時一倂納入計算。$$n$$ 連鎖中每個連鎖的分數都是個別計算，彼此不相關，算完後加總起來。以下讓 $$k$$ 固定，討論第 $$k$$ 連鎖的得分 $$S_k$$ 的計算方式。

## 第 $$k$$ 連鎖得分 $$S_k$$

$$S_k$$ 的計算方式與下列四個數字息息相關：
* 第 $$k$$ 連鎖消除的氣泡數 $$t$$
* $$k$$ 的值
* 第 $$k$$ 連鎖消除的顏色數 $$c$$
* 第 $$k$$ 連鎖的各連結數 $$l_i$$

更精確來說，$$k$$ 、$$c$$、$$l$$ 後面有三個函數分別決定這些值對應到的「獎勵（bonus）」是多少，而這些獎勵與氣泡數 $$t$$ 會一起決定 $$S_k$$。

### 1. 氣泡數 $$t$$

指的是在第 $$k$$ 連鎖消除的所有氣泡數，這應該不須多做解釋～

### 2. $$k$$ 的值

$$k$$ 的值與連鎖獎勵（命名為$$R(k)$$）的關係由下表給出：

| $$k$$ 的值 | 連鎖獎勵 $$R(k)$$ |
|:----------:|:-----------------:|
|  $$1$$     |   $$0$$           |
|  $$2$$     |   $$8$$           |
|  $$3$$     |   $$16$$          |
|  $$4$$     |   $$32$$          |
|  $$5$$     |   $$64$$          |
|  $$6$$     |   $$96$$          |
|  $$7$$     |   $$128$$         |
|  $$8$$     |   $$160$$         |
|  $$9$$     |   $$192$$         |
|  $$10$$    |   $$224$$         |
|  $$11$$    |   $$256$$         |
|  $$12$$    |   $$288$$         |
|  $$13$$    |   $$320$$         |
|  $$14$$    |   $$352$$         |
|  $$15$$    |   $$384$$         |
|  $$16$$    |   $$416$$         |
|  $$17$$    |   $$448$$         |
|  $$18$$    |   $$480$$         |
|  $$19$$    |   $$512$$         |

可以發現到，第 $$1$$ 連鎖沒有獎勵，**$$2$$ 連鎖～$$5$$ 連鎖的獎勵倍增，而 $$5$$ 連鎖以上固定是每次加 $$32$$ 分**。

### 3. 此連鎖消除的顏色數 $$c$$

| 顏色數 $$c$$ | 色數獎勵 $$C(c)$$ |
|:------------:|:-----------------:|
|  $$1$$       |   $$0$$           |
|  $$2$$       |   $$3$$           |
|  $$3$$       |   $$6$$           |
|  $$4$$       |   $$12$$          |
|  $$5$$       |   $$24$$          |

同樣地，單色沒有獎勵，不過 $$2$$ 色～$$5$$ 色的獎勵都是倍數成長。要注意的是，**這個表跟 $$k$$ 沒有關係**，不因 $$k$$ 的大小決定這個表的值；不論連鎖是大是小，每一次消除時都會看消了幾個顏色，只用這個來決定色數獎勵。

### 4. 連結數 $$l$$

| 連結數 $$l$$ | 連結獎勵 $$L(l)$$ |
|:------------:|:-----------------:|
|  $$4$$       |   $$0$$           |
|  $$5$$       |   $$2$$           |
|  $$6$$       |   $$3$$           |
|  $$7$$       |   $$4$$           |
|  $$8$$       |   $$5$$           |
|  $$9$$       |   $$6$$           |
|  $$10$$      |   $$7$$           |
|  $$\ge11$$   |   $$10$$          |

同樣地，這個表也跟 $$k$$ 的大小沒關係，只用連結數多寡來決定獎勵。由於 $$4$$ 顆氣泡是最低能消除的數量，這邊就定成 $$4$$ 連結沒有獎勵。

另外，觀察一下可以發現到，連結數從 $$4$$ 到 $$5$$ 時獎勵 $$+2$$ ，從 $$10$$ 到 $$11$$ 時獎勵 $$+3$$ ，因此 **$$5$$ 連結與 $$11$$ 連結是很有效率的**；另一方面，**$$12$$ 以上的連結則效率低落**，因為他們跟 $$11$$ 連結有一樣的獎勵。

還有一個要注意的點是，如果第 $$k$$ 連鎖消掉的氣泡分成好幾個彼此內部相連的群組，那**每個連結群都會計算一次連結獎勵**！舉例來說，請看{% ref bonus-example %}：

{% figure label: bonus-example %}
![連結獎勵解釋](https://i.imgur.com/fzHcsaz.png) 
{% caption %}
多色多連結獎勵例子
{% endfigure %}

{% reft bonus-example %} 中消除的氣泡有綠色五連結、綠色六連結、黃色五連結、藍色四連結，所以總共的連結獎勵是 $$3+2+3+0=8$$！

###	5. $$S_k$$ 計算方式

現在，我們可以用上面這些數字來表示第 $$k$$ 連鎖得分的公式了。令第 $$k$$ 連鎖消除的總氣泡數為 $$t$$，消除了 $$c$$ 個顏色。另外，假設第 $$k$$ 連鎖消除的所有氣泡分成 $$g$$ 個連結群，而每一群有 $$l_i$$ 個氣泡，$$i = 1, \cdots, g$$（因此 $$\sum_{i=1}^{g}l_i=t$$）。

則第 $$k$$ 連鎖的得分 $$S_k$$ 為

$$ 
S_k = \begin{cases}
    40                                                    &, \text{若 } (k,t)   =  (1,4) \\ 
    10t \left( R(k) + C(c) +\sum_{i=1}^{g} L(l_i) \right) &, \text{若 } (k,t) \neq (1,4)
\end{cases}
$$ 

也就是說，如果 $$k=1$$，而且只消除四顆氣泡，那以上三種獎勵函數的值都是 $$0$$，此情況就直接定義得分為 $$10t=40$$ 分；而其他情況就照著上面的表帶值，算完總和後一樣在外面乘以 $$10t$$。

## 分數計算：實例

至此我們說明了 $$S_k$$ 的計算方法，但是別忘記，發動一個 $$n$$ 連鎖時需要計算每個 $$S_k$$ 再加總起來的。我們就來使用上面的公式算些具體例子吧！回憶一下在[中盤概論]({{ "wiki/C_tactics/b_middle/i_intro" | relative_url }})提到的概念，

> 「*在消掉的氣泡數一樣的前提下，追求高同消與追求高連鎖的分數可能差不多，甚至更多。*」──魔法氣泡中文百科

話說得很含糊，甚麼叫差不多，更多又是怎麼個多法？有了得分計算公式，我們可以精確地說明了。以5A5B的情況為例，不考慮落下得分，則兩連鎖與一連鎖同消的得分如下：

|       |     圖1    |     圖2    |
|:-----:|:----------:|:----------:|
|       |![兩連鎖600分](https://i.imgur.com/IAGhqMu.png)|![一連鎖700分](https://i.imgur.com/MKf9XNQ.png)|

|第1連鎖| $$10 \times 5 \times 2 = 100$$   | $$10 \times 10 \times (3+2+2)=700$$  |
|第2連鎖| $$10 \times 5 \times (8+2)=500$$ |                                      |
|總分   | $$600$$                          | $$700$$                              |

確實是一連鎖同消的得分更高！再比較一下三連鎖與二連雙消，

|       |     圖3    |     圖4    |
|:-----:|:----------:|:----------:|
|       |![三連鎖1000分](https://i.imgur.com/dR6oLJZ.png)|![一連鎖700分](https://i.imgur.com/uMYZegu.png)|

|第1連鎖| $$40$$                          | $$40$$                               |
|第2連鎖| $$10 \times 4 \times 8 = 320$$  | $$10 \times 8 \times (8+3+0+0)=880$$ |
|第3連鎖| $$10 \times 4 \times 16 = 640$$ |                                      |
|總分   | $$1000$$                        | $$920$$                              |

在此情況，二連雙消只少了 $$1$$～$$2$$ 顆氣泡，但能給對手更短的反應時間。

最後再舉一個例子。注意到，圖1與圖2告訴我們一個全消戰的較佳策略：如果開場前五手剛好來了5A5B，用圖2的方式不但更快取得全消，而且分數也高，對全消戰很有利。

那麼，如果開場前四手是4A4B呢？此時應該擺成兩連鎖還是一連鎖同消，哪個比較有利？ 

|兩連鎖|一連鎖同消|
|:----:|:--------:|
|![兩連鎖360分](https://i.imgur.com/F9G3rcC.png)|![一連鎖240分](https://i.imgur.com/muuD101.png)|

讀者可以自行計算作為練習，結果是：左圖 $$360$$ 分、右圖 $$240$$ 分。在4A4B的情況下，兩連鎖雖然會較慢取得全消，但此時攻擊力較高，通常都還是做兩連鎖，而非一連鎖同消。

## 非預設規則的障礙氣泡

{::comment}
| $$k$$ 的值 | 連鎖獎勵 $$R(k)$$ |
|:----------:|:-----------------:|
| $$1$$      | $$0$$             |
| $$2$$      | $$8$$             |
| $$3$$      | $$16$$            |
| $$4$$      | $$32$$            |
| $$5$$      | $$64$$            |
| $$6$$      | $$96$$            |
| $$7$$      | $$128$$           |
| $$8$$      | $$160$$           |
| $$9$$      | $$192$$           |
| $$10$$     | $$224$$           |
| $$11$$     | $$256$$           |
| $$12$$     | $$288$$           |
| $$13$$     | $$320$$           |
| $$14$$     | $$352$$           |
| $$15$$     | $$384$$           |
| $$16$$     | $$416$$           |
| $$17$$     | $$448$$           |
| $$18$$     | $$480$$           |
| $$19$$     | $$512$$           |
| $$20$$     | $$544$$           |
| $$21$$     | $$576$$           |
| $$22$$     | $$608$$           |
| $$23$$     | $$640$$           |
| $$24$$     | $$672$$           |
| $$\ge24$$  | $$672$$           |
{:/comment}

建置中，參考資料[List of attack powers](https://puyonexus.com/wiki/List_of_attack_powers)、[2個消し39連鎖](https://www.youtube.com/watch?v=hH0j24Rfwcg)

## 加倍時間下的障礙氣泡

建置中，參考資料[ぷよぷよフィーバーにおけるマージンタイム到達後のおじゃまぷよレートの変動調査](http://www.inosendo.com/puyo/margintime.html)

[^1]: [ぷよぷよにおける得点計算について](http://sengiken.web.fc2.com/html/tactics/column8.html).
